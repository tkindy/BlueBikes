---
title: "BlueBikes"
author: "Charles Zheng & Tyler Kindy"
date: "March 22, 2019"
output: pdf_document
---

```{r}
library(plyr)
library(reshape)
library(gridExtra)
library(RColorBrewer)
library(tidyverse)
library(ggmap)
library(lubridate)
library(scatterpie)
```

```{r}
bikes <- read_csv("data/bluebikes.csv") %>%
  mutate(
    startday = date(starttime),
    starthour = hour(starttime),
    stopday = date(stoptime),
    stophour = hour(stoptime)
  )
bikes
```

```{r}
bikes %>%
  group_by(`start station id`, `end station id`) %>%
  summarize(count = n()) %>%
  arrange(-count)
```

```{r}
genders = bikes %>%
  group_by(usertype, gender) %>%
  summarize(count = n())
genders
```

Genders:
  0 - unknown
  1 - male
  2 - female

```{r}
starts = bikes %>%
  select(station_id = `start station id`, name = `start station name`, lat = `start station latitude`, lon = `start station longitude`)
ends = bikes %>%
  select(station_id = `end station id`, name = `end station name`, lat = `end station latitude`, lon = `end station longitude`)
stations = bind_rows(starts, ends) %>%
  filter(!grepl("TEMPORARY WINTER LOCATION", name)) %>%
  distinct(station_id, .keep_all = TRUE) %>%
  arrange(station_id)
stations
```

```{r}
start_trips = bikes %>%
  group_by(`start station id`, usertype) %>%
  summarize(count = n()) %>%
  rename(station_id = `start station id`)
end_trips = bikes %>%
  group_by(`end station id`, usertype) %>%
  summarize(count = n()) %>%
  rename(station_id = `end station id`)
usertype_trips = bind_rows(start_trips, end_trips) %>%
  group_by(station_id, usertype) %>%
  summarize(count = sum(count))
cust_trips = usertype_trips %>%
  filter(usertype == "Customer")
sub_trips = usertype_trips %>%
  filter(usertype == "Subscriber")
usertype_ratios = cust_trips %>%
  inner_join(sub_trips, by = c("station_id"), suffix = c("_cust", "_sub")) %>%
  select(station_id, count_cust, count_sub) %>%
  mutate(ratio = count_cust / (count_cust + count_sub)) %>%
  select(station_id, ratio)
usertype_ratios %>%
  arrange(station_id)
```

```{r}
station_ratios = stations %>%
  inner_join(usertype_ratios)
station_ratios
```

```{r}
get_googlemap(
  "42.334885,-71.086294", zoom = 12, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = lon, y = lat, size = ratio), alpha = 0.4, data = station_ratios) +
  labs(size = "Customer Trips / Total") +
  scale_size(range = c(0, 5))
```

This first visualization shows all of the Bluebike stations, and the ratio of their users who are customers vs. subscribers. Customers are pay-per-ride, single-use riders, while subscribers are annual members who have a profile and ride freely within their subscription. We can largely attribute customers to tourists, as it is very unlikely for a tourist of Boston to buy a subscription just to use Bluebikes a few times. By extension, we attribute subscribers to residents, or locals. That is not to say that customers cannot also be residents - the interpretation depends on the location of the bike.

We see that in the Downtown and Back Bay neighborhoods, there is a higher ratio of customers to subscribers. We believe this indicates that tourists prefer biking around these areas of Boston, when they visit. On the flip side, we see that the MIT area has a very small proportion of customers to subscribers, likely evidence that users of those stations are mostly students or other residents. Curiously, we also observe that there is a large ratio of customers to subscribers in the southern Mattapan area. While we could interpret this as a fringe tourist hotspot, a more likely explanation is that residents in that area do not use Bluebikes enough to purchase an annual subscription, and would rather pay per ride.

Below is a zoomed in version of the same plot. Our interpretation of customers as tourists is largely validated by a few stations, with a particularly high ratio, each near common tourist destinations: (1) Museum of Science, (2) Airport, (3) Boston Common.

```{r}
get_googlemap(
  "42.345,-71.075", zoom = 13, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = lon, y = lat, size = ratio), alpha = 0.4, data = station_ratios) +
  labs(size = "Customer Trips / Total") +
  scale_size(range = c(0, 5))
```


```{r}
bikes_sliced = bikes[c(1:50000),]

morning_bikes = bikes_sliced %>%
  filter(starthour > 6) %>%
  filter(starthour < 10)

get_googlemap(
  "42.345,-71.075", zoom = 12, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = `start station longitude`, y = `start station latitude`), alpha = 0.04, color="red", data = morning_bikes, position = position_jitter(width = 0.006, height = 0.006)) +
  geom_point(aes(x = `end station longitude`, y = `end station latitude`), alpha = 0.03, color="blue", data = morning_bikes, position = position_jitter(width = 0.006, height = 0.006)) +
  theme_void()
```

```{r}
evening_bikes = bikes_sliced %>%
  filter(starthour > 15) %>%
  filter(starthour < 19)

get_googlemap(
  "42.345,-71.075", zoom = 12, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = `start station longitude`, y = `start station latitude`), alpha = 0.02, color="red", data = evening_bikes, position = position_jitter(width = 0.006, height = 0.006)) +
  geom_point(aes(x = `end station longitude`, y = `end station latitude`), alpha = 0.015, color="blue", data = evening_bikes, position = position_jitter(width = 0.006, height = 0.006)) +
  theme_void()
```

```{r}
real_users = bikes %>%
  filter(`birth year` != "NULL") %>%
  mutate(`birth year` = parse_integer(`birth year`)) %>%
  filter(!(`birth year` == 1969 & gender == 0))
real_users %>%
  mutate(birth_decade = trunc(`birth year` / 10) * 10) %>%
  group_by(birth_decade) %>%
  summarize(count = n()) %>%
  arrange(-count)
```

```{r}
real_users %>%
  group_by(`birth year`) %>%
  summarize(count = n()) %>%
  arrange(-count)
```

```{r}
real_users %>%
  ggplot() +
  geom_bar(aes(x = `birth year`))
```

```{r}
real_users <- real_users %>%
  filter(`birth year` >= 1920)

real_users %>%
  ggplot() +
  geom_bar(aes(x = `birth year`)) +
  labs(
    title = "Birth Year of Users Born After 1920",
    x = "Birth Year",
    y = "Number of Users"
  )
```

## Visualization 4: Station Demographics

```{r}
genders_start = real_users %>%
  group_by(`start station id`, gender) %>%
  summarize(count = n()) %>%
  rename(station_id = `start station id`)
genders_end = real_users %>%
  group_by(`end station id`, gender) %>%
  summarize(count = n()) %>%
  rename(station_id = `end station id`)
genders = genders_start %>%
  inner_join(genders_end, by = c("station_id", "gender"), suffix = c("_start", "_end")) %>%
  select(station_id, gender, count_start, count_end) %>%
  mutate(trips = count_start + count_end) %>%
  select(station_id, gender, trips) %>%
  arrange(station_id)

genders <- cast(genders, station_id~gender, fill = 0)
genders
```

```{r}
ages_start = real_users %>%
  mutate(birth_decade = trunc(`birth year` / 10) * 10) %>%
  group_by(`start station id`, birth_decade) %>%
  summarize(count = n()) %>%
  rename(station_id = `start station id`)
ages_end = real_users %>%
  mutate(birth_decade = trunc(`birth year` / 10) * 10) %>%
  group_by(`end station id`, birth_decade) %>%
  summarize(count = n()) %>%
  rename(station_id = `end station id`)
ages = ages_start %>%
  inner_join(ages_end, by = c("station_id", "birth_decade"), suffix = c("_start", "_end")) %>%
  select(station_id, birth_decade, count_start, count_end) %>%
  mutate(trips = count_start + count_end) %>%
  select(station_id, birth_decade, trips) %>%
  arrange(station_id)
ages <- cast(ages, station_id~birth_decade, fill = 0)
ages
```

```{r}
gender_stations = genders %>%
  inner_join(stations) %>%
  mutate(total = `0` + `1` + `2`, male_ratio = `1` / total, female_ratio = `2` / total) %>%
  filter(total >= 500)
gender_stations
```

```{r}
male_stations = gender_stations %>%
  top_n(15, male_ratio)

female_stations = gender_stations %>%
  top_n(15, female_ratio)

gender_stations_subset = bind_rows(male_stations, female_stations) %>%
  distinct(station_id, .keep_all = TRUE)

get_googlemap(
  "42.345,-71.075", zoom = 13, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_scatterpie(aes(x = lon, y = lat, r = 0.002), data = gender_stations_subset, cols = c("0", "1", "2")) +
  scale_fill_manual(values = c("0" = "gray", "1" = "blue", "2" = "pink")) +
  coord_equal() +
  theme_void()
```

```{r}
age_stations = ages %>%
  mutate(total = `1920` + `1930` + `1940` + `1950` + `1960` + `1970` + `1980` + `1990` + `2000`) %>%
  top_n(50, total) %>%
  inner_join(stations)

get_googlemap(
  "42.370,-71.085", zoom = 13, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_scatterpie(aes(x = lon, y = lat, r = 0.002), data = age_stations, cols = c("1920", "1930", "1940", "1950", "1960", "1970", "1980", "1990", "2000")) +
  coord_equal() +
  theme_void()
```

## Visualization 3: Station Activity

```{r}
bucket_date <- function(time) {
  bucket <- floor_date(time, unit = "30 minutes")
  year(bucket) <- 1900
  month(bucket) <- 1
  day(bucket) <- 1
  bucket
}

time_buckets = bikes %>%
  mutate(
    start_bucket = bucket_date(starttime),
    end_bucket = bucket_date(stoptime)
  ) %>%
  select(`start station id`, `end station id`, start_bucket, end_bucket)
```

```{r}
start_buckets = time_buckets %>%
  group_by(`start station id`, start_bucket) %>%
  summarize(count = n())

end_buckets = time_buckets %>%
  group_by(`end station id`, end_bucket) %>%
  summarize(count = n())

start_buckets
```

```{r}
grouped_buckets = start_buckets %>%
  inner_join(end_buckets, by = c("start station id" = "end station id", "start_bucket" = "end_bucket")) %>%
  select(station_id = `start station id`, bucket = start_bucket, start_count = count.x, end_count = count.y)

grouped_buckets
```

```{r}
keepers = grouped_buckets %>%
  group_by(station_id) %>%
  summarize(total_count = sum(start_count) + sum(end_count)) %>%
  top_n(40, total_count)
keepers %>%
  arrange(-total_count)

sep_buckets = grouped_buckets %>%
  semi_join(keepers) %>%
  split(.$station_id)
```

```{r}
max_y = max(
  (grouped_buckets %>%
  filter(start_count == max(start_count)) %>%
    pull(start_count)),
  (grouped_buckets %>%
     filter(end_count == max(end_count)) %>%
     pull(end_count))
)
```

For our third visualization, we wanted to look at the network activity on a per-station basis. What times of day are active and inactive for each station in the network? This information would be useful to Bluebikes itself. Stations with high demand during a given time period could run out of bikes during the rush hour. However, if another station is a hot destination point during that same time period, there is an opportunity for some real-time network rebalancing by moving the bikes to stations where they're needed.

This information could also be of interest to Bluebikes riders. These statistics could be used to give users an idea of when rush hour is for their favorite or home station, enabling them to plan further ahead for their commute or other ride.

```{r, fig.width=10, fig.height=20}

graphs = sep_buckets %>%
  map(function(bucket_tbl) {
    id = (bucket_tbl %>% select(station_id) %>% head(1))[[1]]
    name = (bucket_tbl %>% inner_join(stations) %>% select(name) %>% head(1))[[2]]
    bucket_tbl %>%
      ggplot() +
      geom_line(aes(x = bucket, y = start_count, color = "red")) +
      geom_line(aes(x = bucket, y = end_count, color = "blue")) +
      # coord_cartesian(ylim = c(0, max_y)) +
      # labs(title = str_interp("${id}")) +
      labs(title = name) +
      # theme_void() +
      theme(
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
      )
  })

splat(grid.arrange)(graphs, ncol = 2)
```

Before analyzing this visualization, it's important to understand what it's displaying. First, each graph contains data for a typical day in 2018. Each X-axis represents the 24 hours in a day. However, the graphs cannot be compared to one another directly since they're each plotted with their own Y-axis corresponding to their own average data. These graphs should be viewed as a way of seeing the daily trend at a particular station. For clarity, we have chosen to show the 40 most active stations.

With that explanation out of the way, there are many interesting conclusions we can draw from this visualization. Many of the stations conform to a typical rush hour schedule, such as MIT Stata Center (with an outward morning commute and inward evening commute) and Nashua Street at Red Auerbach Way (with the opposite cycle). Some stations, like Back Bay, are clearly hubs of transit where many people are leaving from and coming to at both rush hours. This could also be the case for stations that are close to both residential and business areas like Lechmere Station.

Many stations are less defined, however. For example, Beacon Street at Arlington Street has a small bidirectional morning commute which then steadily increases in traffic throughout the day until the end of the evening commute. This particular station is right by the Commons and the Public Gardens, so it would make sense that many people (especially in the summer) are interacting with this station.

Overall, this visualization answered some questions for us about station traffic and could provide valuable insights to Bluebikes and its customers combined. It also raises some more interesting questions about how these stations are being used that other visualizations could shed more light on, such as how the traffic at one station might affect the traffic of the stations around it.

```
trip_durations = real_users %>%
  mutate(trip_duration = difftime(`stoptime`, `starttime`)) %>%
  filter(trip_duration < 90) %>%
  group_by(`start station id`, `end station id`, `start station latitude`,`end station latitude`,`start station longitude`,`end station longitude`) %>%
  summarize(trip_duration = mean(`trip_duration`), count = n()) %>%
  filter(count > 100) %>%
  arrange(-count)

trip_durations_top = trip_durations %>%
  filter(count > 100) 
```

```
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")))
sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(1, 45))

get_googlemap(
  "42.354,-71.076", zoom = 13, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_segment(data=trip_durations_top,aes(x = `start station longitude`, y = `start station latitude`, xend = `end station longitude`, yend = `end station latitude`, color = as.numeric(`trip_duration`), alpha=`count`)) +
  sc

```
