---
title: "BlueBikes"
author: "Tyler Kindy"
date: "March 22, 2019"
output: pdf_document
---

```{r}
library(tidyverse)
library(lubridate)

bikes <- read_csv("data/bluebikes.csv") %>%
  mutate(
    startday = date(starttime), 
    starthour = hour(starttime),
    stopday = date(stoptime),
    stophour = hour(stoptime)
  )

bikes
```

```{r}
bikes %>%
  group_by(`start station id`, `end station id`) %>%
  summarize(count = n()) %>%
  arrange(-count)
```

```{r}
genders = bikes %>%
  group_by(usertype, gender) %>%
  summarize(count = n())

genders
```

Genders:
  0 - unknown
  1 - male
  2 - female
  
```{r}
starts = bikes %>%
  select(station_id = `start station id`, lat = `start station latitude`, lon = `start station longitude`)

ends = bikes %>%
  select(station_id = `end station id`, lat = `end station latitude`, lon = `end station longitude`)

stations = bind_rows(starts, ends) %>%
  distinct(station_id, .keep_all = TRUE) %>%
  arrange(station_id)

stations
```

```{r}
start_trips = bikes %>%
  group_by(`start station id`, usertype) %>%
  summarize(count = n()) %>%
  rename(station_id = `start station id`)

end_trips = bikes %>%
  group_by(`end station id`, usertype) %>%
  summarize(count = n()) %>%
  rename(station_id = `end station id`)

usertype_trips = bind_rows(start_trips, end_trips) %>%
  group_by(station_id, usertype) %>%
  summarize(count = sum(count))

cust_trips = usertype_trips %>%
  filter(usertype == "Customer")

sub_trips = usertype_trips %>%
  filter(usertype == "Subscriber")

usertype_ratios = cust_trips %>%
  inner_join(sub_trips, by = c("station_id"), suffix = c("_cust", "_sub")) %>%
  select(station_id, count_cust, count_sub) %>%
  mutate(ratio = count_cust / (count_cust + count_sub)) %>%
  select(station_id, ratio)

usertype_ratios %>%
  arrange(station_id)
```

```{r}
library(ggmap)

station_ratios = stations %>%
  inner_join(usertype_ratios)

station_ratios
```

```{r}
get_googlemap(
  "42.334885,-71.086294", zoom = 12, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = lon, y = lat, size = ratio), alpha = 0.4, data = station_ratios) +
  labs(size = "Customer Trips / Total")
  theme_void()
```

```{r}
get_googlemap(
  "42.345,-71.075", zoom = 13, maptype = "roadmap",
  style = c(feature = "poi", visibility = "off")
) %>%
  ggmap() +
  geom_point(aes(x = lon, y = lat, size = ratio), alpha = 0.4, data = station_ratios) +
  labs(size = "Customer Trips / Total")
  theme_void()
```

```{r}
users = bikes %>%
  filter(`birth year` != "NULL") %>%
  mutate(`birth year` = parse_integer(`birth year`))

real_users = users %>%
  filter(!(`birth year` == 1969 & gender == 0))

real_users %>%
  mutate(birth_decade = trunc(`birth year` / 10) * 10) %>%
  group_by(birth_decade) %>%
  summarize(count = n()) %>%
  arrange(-count)
```

```{r}
birth_buckets = real_users %>%
  group_by(`birth year`) %>%
  summarize(count = n()) %>%
  arrange(-count)

birth_buckets
```

```{r}
birth_buckets %>%
  ggplot() +
  geom_bar(aes(x = `birth year`, fill = count))
```
